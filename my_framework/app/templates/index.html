<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Journalist Bot v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .container { max-width: 1200px; margin: auto; padding: 2rem; }
        .form-input, .form-textarea, .form-select {
            background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem;
            padding: 0.5rem 0.75rem; width: 100%; color: #d1d5db;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: 2px solid #3b82f6; border-color: transparent; }
        .btn {
            background-color: #2563eb; color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; border: none; cursor: pointer; transition: background-color 0.2s;
        }
        .btn:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn:disabled { background-color: #4b5563; cursor: not-allowed; }
        .btn-secondary { background-color: #4b5563; }
        .btn-secondary:hover { background-color: #374151; }
        .btn-success { background-color: #059669; }
        .btn-success:hover { background-color: #047857; }
        .label { display: block; margin-bottom: 0.25rem; font-weight: 500; color: #9ca3af; }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .tab-content { display: none; }
        .tab-content-active { display: block; }
        #log-container {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 2rem;
            height: 400px;
            overflow-y: scroll;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .info-banner {
            background-color: #1e3a5f;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
        }
        .info-banner.success {
            background-color: #1e4d3c;
            border-left-color: #059669;
        }
        .info-banner.warning {
            background-color: #4d3d1e;
            border-left-color: #f59e0b;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">AI Journalist Bot</h1>
            <p class="text-xl text-gray-400">Version 2.0 with Style Guru</p>
            <div id="style-guru-status" class="mt-4"></div>
        </header>

        <main>
            <div id="main-content">
                <div class="flex border-b border-gray-700 max-w-4xl mx-auto mb-6">
                    <div id="tab-urls" class="tab tab-active" onclick="showTab('urls')">From URLs</div>
                    <div id="tab-prewritten" class="tab" onclick="showTab('prewritten')">Pre-written</div>
                    <div id="tab-rewrite" class="tab" onclick="showTab('rewrite')">Rewrite Only</div>
                    <div id="tab-sheets" class="tab" onclick="showTab('sheets')">From Google Sheet</div>
                    <div id="tab-settings" class="tab" onclick="showTab('settings')">Settings</div>
                </div>

                <div id="content-urls" class="tab-content tab-content-active max-w-4xl mx-auto space-y-6">
                    <div class="info-banner">
                        <p class="text-sm"><strong>‚ú® Style Guru Mode:</strong> Articles from URLs will be scored and refined iteratively until they meet IntelliNews quality standards (0.80+).</p>
                    </div>
                </div>
                <div id="content-prewritten" class="tab-content max-w-4xl mx-auto space-y-6">
                    <div class="info-banner warning">
                        <p class="text-sm"><strong>üìÑ Pre-written Articles:</strong> These will be scored for informational purposes but submitted as-is without modification.</p>
                    </div>
                </div>
                <div id="content-rewrite" class="tab-content max-w-4xl mx-auto space-y-6">
                    <div class="info-banner success">
                        <p class="text-sm"><strong>‚úçÔ∏è Rewrite Only:</strong> Fetch and rewrite articles without publishing. View the refined article and its score in real-time.</p>
                    </div>
                </div>
                <div id="content-sheets" class="tab-content max-w-4xl mx-auto space-y-6">
                </div>
                <div id="content-settings" class="tab-content max-w-4xl mx-auto space-y-6">
                </div>

                <div id="log-container" class="max-w-4xl mx-auto"></div>
            </div>
        </main>
    </div>

    <script>
        const ui = {
            tabs: {},
            tabContents: {}
        };

        // Check Style Guru status on page load
        async function checkStyleGuruStatus() {
            try {
                const response = await fetch('/style-guru-status');
                const data = await response.json();
                const statusDiv = document.getElementById('style-guru-status');
                
                if (data.framework_exists) {
                    statusDiv.innerHTML = `
                        <div class="info-banner success">
                            <p class="text-sm">
                                <strong>‚úÖ Style Guru Active</strong> - 
                                Articles analyzed: ${data.articles_analyzed || 'Unknown'} | 
                                <a href="/style-guru" class="text-blue-400 hover:text-blue-300 underline">Manage Style Guru</a>
                            </p>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="info-banner warning">
                            <p class="text-sm">
                                <strong>‚ö†Ô∏è Style Guru Not Configured</strong> - 
                                Articles will not be scored. 
                                <a href="/style-guru" class="text-blue-400 hover:text-blue-300 underline">Set up Style Guru</a>
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to check Style Guru status:', error);
            }
        }

        function showTab(tabName) {
            for (const name in ui.tabs) {
                ui.tabs[name].classList.toggle('tab-active', name === tabName);
                ui.tabContents[name].classList.toggle('tab-content-active', name === tabName);
            }
        }

        function getSettings() {
            return {
                openai_api_key: document.getElementById('openai_api_key').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
        }

        function saveSettings() {
            const settings = getSettings();
            localStorage.setItem('aiJournalistSettings', JSON.stringify(settings));
            alert('Settings saved!');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('aiJournalistSettings'));
            if (settings) {
                document.getElementById('openai_api_key').value = settings.openai_api_key || '';
                document.getElementById('username').value = settings.username || '';
                document.getElementById('password').value = settings.password || '';
                alert('Settings loaded!');
            } else {
                alert('No saved settings found.');
            }
        }

        async function runWorkflow(config) {
            const button = event.target;
            setBotRunning(true, button);
            try {
                const response = await fetch('/invoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: config })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'An unknown error occurred.');
            } catch (error) {
                console.error(`Error running workflow: ${error.message}`);
                alert(`Error: ${error.message}`);
            } finally {
                setBotRunning(false, button);
            }
        }

        function submitSingleUrl(id) {
            const url = document.getElementById(`source_url_${id}`).value;
            if (!url) {
                alert('Please enter a URL.');
                return;
            }
            const config = {
                ...getSettings(),
                user_goal: `Write an article based on the content from the URL: ${url}`,
                source_url: url
            };
            runWorkflow(config);
        }

        function submitAllUrls() {
            const urlInputs = document.querySelectorAll('#content-urls input[type="text"]');
            urlInputs.forEach(input => {
                const url = input.value;
                if (url) {
                    const config = {
                        ...getSettings(),
                        user_goal: `Write an article based on the content from the URL: ${url}`,
                        source_url: url
                    };
                    runWorkflow(config);
                }
            });
        }

        function submitSinglePrewritten(id) {
            const text = document.getElementById(`article_text_${id}`).value;
            if (!text) {
                alert('Please paste the article text.');
                return;
            }
            const config = {
                ...getSettings(),
                user_goal: 'Publish the following pre-written article.',
                source_content: text
            };
            runWorkflow(config);
        }

        function submitFromSheet() {
            const sheetUrl = document.getElementById('sheet_url').value;
            const worksheetName = document.getElementById('worksheet_name').value;
            if (!sheetUrl || !worksheetName) {
                alert('Please enter a Google Sheet URL and worksheet name.');
                return;
            }
            const config = {
                ...getSettings(),
                user_goal: 'Process articles from the Google Sheet.',
                sheet_url: sheetUrl,
                worksheet_name: worksheetName
            };
            runWorkflow(config);
        }

        async function rewriteArticle() {
            const url = document.getElementById('rewrite_url').value;
            if (!url) {
                alert('Please enter a URL.');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';
            
            // Hide results initially
            document.getElementById('rewrite-results').classList.add('hidden');
            
            try {
                const response = await fetch('/rewrite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        input: {
                            source_url: url,
                            openai_api_key: document.getElementById('openai_api_key').value
                        }
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.detail || data.error || 'An error occurred');
                
                console.log('Received data:', data);  // Debug logging
                
                // Show results
                document.getElementById('rewrite-results').classList.remove('hidden');
                
                // Display scores with proper fallbacks
                const score = parseFloat(data.score) || 0.0;
                const componentScores = data.component_scores || {};
                
                document.getElementById('score-value').textContent = score.toFixed(2);
                document.getElementById('lead-score').textContent = (parseFloat(componentScores.lead_quality) || 0.0).toFixed(2);
                document.getElementById('structure-score').textContent = (parseFloat(componentScores.structure) || 0.0).toFixed(2);
                document.getElementById('vocab-score').textContent = (parseFloat(componentScores.vocabulary) || 0.0).toFixed(2);
                document.getElementById('tone-score').textContent = (parseFloat(componentScores.tone) || 0.0).toFixed(2);
                document.getElementById('attr-score').textContent = (parseFloat(componentScores.attribution) || 0.0).toFixed(2);
                
                // Color code overall score
                const scoreEl = document.getElementById('score-value');
                if (score >= 0.85) {
                    scoreEl.className = 'text-2xl font-bold text-green-400';
                } else if (score >= 0.80) {
                    scoreEl.className = 'text-2xl font-bold text-blue-400';
                } else if (score >= 0.70) {
                    scoreEl.className = 'text-2xl font-bold text-yellow-400';
                } else {
                    scoreEl.className = 'text-2xl font-bold text-red-400';
                }
                
                // Display article with proper formatting
                let article = data.article || 'No article content';
                
                // Clean up any remaining feedback markers
                article = article.replace(/‚ïê+/g, '');
                article = article.replace(/‚îÄ+/g, '');
                article = article.replace(/‚ñº+/g, '');
                article = article.replace(/‚úÖ+/g, '');
                
                // Ensure proper paragraph spacing
                article = article.split('\n\n').map(p => p.trim()).filter(p => p).join('\n\n');
                
                document.getElementById('rewritten-article').value = article;
                
                // Display feedback
                const feedback = data.feedback || 'No feedback available';
                document.getElementById('rewrite-feedback').value = feedback;
                
                // Show iteration info if available
                if (data.iterations) {
                    console.log(`Article refined through ${data.iterations} iterations`);
                }
                
                // Scroll to results
                document.getElementById('rewrite-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                console.error(`Error rewriting article:`, error);
                alert(`Error: ${error.message}\n\nCheck the console logs for more details.`);
            } finally {
                button.disabled = false;
                button.innerHTML = '‚úçÔ∏è Rewrite Article';
            }
        }

        function copyArticle() {
            const article = document.getElementById('rewritten-article');
            article.select();
            document.execCommand('copy');
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚úÖ Copied!';
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 2000);
        }

        function setBotRunning(isRunning, button) {
            if (button) {
                button.disabled = isRunning;
                button.innerHTML = isRunning ? '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>' : 'Submit to CMS';
            }
        }

        function createUrlInput(index) {
            const id = index + 1;
            return `
                <div class="bg-gray-800 p-6 rounded-lg" data-id="${id}">
                    <h3 class="text-xl font-semibold text-white mb-4">Article ${id}</h3>
                    <div class="flex items-end space-x-4">
                        <div class="flex-grow">
                            <label for="source_url_${id}" class="label">Source URL</label>
                            <input type="text" id="source_url_${id}" class="form-input">
                        </div>
                        <button class="btn h-10 w-40" onclick="submitSingleUrl(${id})">Submit to CMS</button>
                    </div>
                </div>
            `;
        }

        function createPrewrittenInput(index) {
            const id = index + 1;
            return `
                <div class="bg-gray-800 p-6 rounded-lg" data-id="${id}">
                    <h3 class="text-xl font-semibold text-white mb-4">Article ${id}</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="article_text_${id}" class="label">Paste Full Article Text</label>
                            <textarea id="article_text_${id}" class="form-textarea" rows="8"></textarea>
                        </div>
                        <button class="btn w-full" onclick="submitSinglePrewritten(${id})">Submit to CMS</button>
                    </div>
                </div>
            `;
        }
        
        function initializeUI() {
            ui.tabs.urls = document.getElementById('tab-urls');
            ui.tabs.prewritten = document.getElementById('tab-prewritten');
            ui.tabs.rewrite = document.getElementById('tab-rewrite');
            ui.tabs.sheets = document.getElementById('tab-sheets');
            ui.tabs.settings = document.getElementById('tab-settings');

            ui.tabContents.urls = document.getElementById('content-urls');
            ui.tabContents.prewritten = document.getElementById('content-prewritten');
            ui.tabContents.rewrite = document.getElementById('content-rewrite');
            ui.tabContents.sheets = document.getElementById('content-sheets');
            ui.tabContents.settings = document.getElementById('content-settings');

            // URLs Tab
            let urlsHTML = '<button class="btn btn-success w-full mb-6" onclick="submitAllUrls()">Submit All URLs to CMS</button>';
            for (let i = 0; i < 3; i++) {
                urlsHTML += createUrlInput(i);
            }
            ui.tabContents.urls.innerHTML += urlsHTML;

            // Pre-written Tab
            let prewrittenHTML = '';
            for (let i = 0; i < 3; i++) {
                prewrittenHTML += createPrewrittenInput(i);
            }
            ui.tabContents.prewritten.innerHTML += prewrittenHTML;

            // Rewrite Only Tab
            ui.tabContents.rewrite.innerHTML += `
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-white mb-4">Rewrite Article (No Publishing)</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="rewrite_url" class="label">Source URL</label>
                            <input type="text" id="rewrite_url" class="form-input" placeholder="https://example.com/article">
                        </div>
                        <button class="btn w-full" onclick="rewriteArticle()">‚úçÔ∏è Rewrite Article</button>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="rewrite-results" class="mt-6 hidden">
                        <div class="border-t border-gray-700 pt-6">
                            <h4 class="text-lg font-semibold text-white mb-3">Results</h4>
                            
                            <!-- Score Display -->
                            <div id="rewrite-score" class="mb-4 p-4 rounded bg-gray-700">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-300">Overall Score:</span>
                                    <span id="score-value" class="text-2xl font-bold text-blue-400">-</span>
                                </div>
                                <div class="mt-2 text-sm text-gray-400">
                                    <div class="flex justify-between"><span>Lead Quality:</span><span id="lead-score">-</span></div>
                                    <div class="flex justify-between"><span>Structure:</span><span id="structure-score">-</span></div>
                                    <div class="flex justify-between"><span>Vocabulary:</span><span id="vocab-score">-</span></div>
                                    <div class="flex justify-between"><span>Tone:</span><span id="tone-score">-</span></div>
                                    <div class="flex justify-between"><span>Attribution:</span><span id="attr-score">-</span></div>
                                </div>
                            </div>
                            
                            <!-- Rewritten Article -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="label">Rewritten Article</label>
                                    <button class="btn btn-secondary" onclick="copyArticle()">üìã Copy to Clipboard</button>
                                </div>
                                <textarea id="rewritten-article" class="form-textarea" rows="20" readonly></textarea>
                            </div>
                            
                            <!-- Feedback -->
                            <div class="mt-4">
                                <label class="label">Style Guru Feedback</label>
                                <textarea id="rewrite-feedback" class="form-textarea" rows="10" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Google Sheets Tab
            ui.tabContents.sheets.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold text-white mb-4">Google Sheet Import</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="sheet_url" class="label">Google Sheet URL</label>
                            <input type="text" id="sheet_url" class="form-input">
                        </div>
                        <div>
                            <label for="worksheet_name" class="label">Worksheet Name</label>
                            <input type="text" id="worksheet_name" class="form-input" value="Sheet1">
                        </div>
                        <button class="btn w-full" onclick="submitFromSheet()">Submit from Sheet</button>
                    </div>
                </div>
            `;

            // Settings Tab
            ui.tabContents.settings.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold text-white mb-4">Configuration</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="openai_api_key" class="label">OpenAI API Key</label>
                            <input type="password" id="openai_api_key" class="form-input">
                        </div>
                        <div>
                            <label for="username" class="label">CMS Username</label>
                            <input type="text" id="username" class="form-input">
                        </div>
                        <div>
                            <label for="password" class="label">CMS Password</label>
                            <input type="password" id="password" class="form-input">
                        </div>
                        <div class="flex space-x-4 pt-4">
                            <button class="btn btn-secondary w-full" onclick="saveSettings()">Save Settings</button>
                            <button class="btn btn-secondary w-full" onclick="loadSettings()">Load Settings</button>
                        </div>
                    </div>
                </div>
            `;

            loadSettings();
            checkStyleGuruStatus();
        }

        // WebSocket for logs
        let ws = null;
        function connectWebSocket() {
            try {
                ws = new WebSocket(`ws://${window.location.host}/ws`);
                ws.onmessage = (event) => {
                    const logContainer = document.getElementById('log-container');
                    const logEntry = document.createElement('div');
                    logEntry.textContent = event.data;
                    
                    // Color code important messages
                    if (event.data.includes('‚úÖ')) logEntry.style.color = '#10b981';
                    if (event.data.includes('‚ùå') || event.data.includes('üî•')) logEntry.style.color = '#ef4444';
                    if (event.data.includes('‚ö†Ô∏è')) logEntry.style.color = '#f59e0b';
                    if (event.data.includes('SCORE:')) logEntry.style.color = '#3b82f6';
                    
                    logContainer.appendChild(logEntry);
                    logContainer.scrollTop = logContainer.scrollHeight;
                };
                ws.onerror = (error) => console.error('WebSocket Error:', error);
            } catch (error) {
                console.error('Failed to connect to WebSocket:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            connectWebSocket();
        });
    </script>
</body>
</html>